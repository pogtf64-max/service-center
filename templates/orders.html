{% extends "base.html" %}

{% block title %}Заказы{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header-modern fade-in">
    <h1 class="display-4 mb-3">
        <i class="bi bi-clipboard-check"></i> Управление заказами
    </h1>
    <p class="lead text-muted">Создание, редактирование и отслеживание заказов</p>
</div>

<!-- Search and Filter Section -->
<div class="search-filter-section mb-4">
    <div class="row">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" id="searchOrders" placeholder="Поиск заказов...">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                <i class="bi bi-plus-circle"></i> Новый заказ
            </button>
        </div>
    </div>
</div>

<!-- Orders List -->
<div class="orders-container">
    {% if orders %}
        {% for order in orders %}
        <div class="order-card mb-3" data-order-id="{{ order.id }}">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">
                                <i class="bi bi-clipboard-check"></i> Заказ #{{ order.id }}
                            </h5>
                            <div class="order-details">
                                <p class="mb-1"><strong>Клиент:</strong> {{ order.client.name if order.client else 'Не указан' }}</p>
                                <p class="mb-1"><strong>Устройство:</strong> {{ order.device.name if order.device else 'Не указано' }}</p>
                                <p class="mb-1"><strong>Мастер:</strong> {{ order.master.full_name if order.master else 'Не назначен' }}</p>
                                <p class="mb-1"><strong>Дата приема:</strong> {{ order.created_at.strftime('%d.%m.%Y') }}</p>
                                <p class="mb-1"><strong>Стоимость:</strong> <span id="order-cost-{{ order.id }}">{{ "%.2f"|format(order.total_cost) }} ₽</span></p>
                                <p class="mb-0"><strong>Статус:</strong> 
                                    <span class="badge bg-{{ 'success' if order.status == 'ready' else 'warning' if order.status == 'received' else 'info' }}">
                                        {{ order.get_status_display() }}
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="order-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewOrder({{ order.id }})" title="Просмотр">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editOrder({{ order.id }})" title="Редактировать">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="changeStatus({{ order.id }})" title="Изменить статус">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="showAcceptanceAct({{ order.id }})" title="Акт приема">
                                    <i class="bi bi-file-text"></i>
                                </button>
                            </div>
                            {% if order.status == 'received' %}
                            <div class="mt-2">
                                <button class="btn btn-success btn-sm" onclick="takeToWork({{ order.id }})">
                                    <i class="bi bi-hand-thumbs-up"></i> Взять в работу
                                </button>
                            </div>
                            {% endif %}
                            <div class="order-meta mt-2">
                                <small class="text-muted">Создан: {{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-clipboard-x display-1 text-muted"></i>
            <h3 class="mt-3">Заказы не найдены</h3>
            <p class="text-muted">Создайте первый заказ, чтобы начать работу</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                <i class="bi bi-plus-circle"></i> Создать заказ
            </button>
        </div>
    {% endif %}
</div>

<!-- New Order Modal -->
<div class="modal fade" id="newOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Новый заказ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newOrderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientSelect" class="form-label">Клиент</label>
                                <select class="form-select" id="clientSelect" name="client_id" required>
                                    <option value="">Выберите клиента</option>
                                    <!-- Клиенты будут загружены через JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceSelect" class="form-label">Устройство</label>
                                <select class="form-select" id="deviceSelect" name="device_id" required>
                                    <option value="">Выберите устройство</option>
                                    <!-- Устройства будут загружены через JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Описание проблемы</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="diagnosis" class="form-label">Диагностика</label>
                        <textarea class="form-control" id="diagnosis" name="diagnosis" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">
                    <i class="bi bi-check-circle"></i> Создать заказ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Status Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat"></i> Изменение статуса заказа
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changeStatusForm">
                    <input type="hidden" id="changeStatusOrderId" name="order_id">
                    <input type="hidden" id="changeStatusOldStatus" name="old_status">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Новый статус</label>
                        <select class="form-select" id="newStatus" name="new_status" required>
                            <option value="">Выберите статус</option>
                            <option value="received">Принят</option>
                            <option value="requires_approval">Требует одобрения</option>
                            <option value="parts_order">Заказ запчастей</option>
                            <option value="parts_ordered">Запчасти заказаны</option>
                            <option value="ready">Готов</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusComment" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="statusComment" name="comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveStatusChange()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div class="modal fade" id="documentPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-a4">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-eye"></i> Предварительный просмотр: <span id="previewDocumentType"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body a4-preview">
                <div id="documentPreviewContent" class="a4-document">
                    <!-- Содержимое документа будет загружено здесь -->
                </div>
                <input type="hidden" id="previewDocumentTypeValue">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="printFromPreview()">
                    <i class="bi bi-printer"></i> Печать
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/orders.js') }}?v=1.0"></script>
<script>
// Изменение статуса заказа
function changeOrderStatus(orderId, currentStatus) {
    document.getElementById('changeStatusOrderId').value = orderId;
    document.getElementById('changeStatusOldStatus').value = currentStatus;
    document.getElementById('newStatus').value = currentStatus;
    document.getElementById('statusComment').value = '';
    
    new bootstrap.Modal(document.getElementById('changeStatusModal')).show();
}
</script>
{% endblock %}
