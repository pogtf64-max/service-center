{% extends "base.html" %}

{% block title %}Заказы{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header-modern fade-in">
    <h1 class="display-4 mb-3">
        <i class="bi bi-clipboard-check"></i> Управление заказами
    </h1>
    <p class="lead mb-0">Создание и управление заказами сервисного центра</p>
</div>

<!-- Add Order Button -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-end">
            <button class="btn btn-success-modern btn-modern" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                <i class="bi bi-plus-circle"></i> Новый заказ
            </button>
        </div>
    </div>
</div>

<!-- Orders Cards -->
<div class="modern-card slide-in-left">
    <div class="search-modern">
        <i class="bi bi-search search-icon"></i>
        <input type="text" class="form-control modern-form-control" id="searchOrders" placeholder="Поиск заказов...">
    </div>
    
    <div class="row" id="ordersContainer">
                    {% for order in orders %}
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4 order-card">
                <div class="modern-card h-100 scale-in">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 text-primary">
                            <i class="bi bi-clipboard-check"></i> Заказ #{{ order.id }}
                        </h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info-modern btn-modern" onclick="viewOrder({{ order.id }})" title="Просмотр">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning-modern btn-modern" onclick="editOrder({{ order.id }})" title="Редактировать">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-primary-modern btn-modern" onclick="changeStatus({{ order.id }})" title="Изменить статус">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary-modern btn-modern" onclick="showAcceptanceAct({{ order.id }})" title="Акт приема">
                                <i class="bi bi-file-earmark-text"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Клиент:</strong><br>
                                <span class="text-primary">{{ order.client.name }}</span>
                            </div>
                            <div class="col-6">
                                <strong>Устройство:</strong><br>
                                <span>{{ order.device.brand }} {{ order.device.model }}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Мастер:</strong><br>
                                <span>{{ order.master.full_name if order.master else 'Не назначен' }}</span>
                            </div>
                            <div class="col-6">
                                <strong>Дата приема:</strong><br>
                                <span>{{ order.date_received.strftime('%d.%m.%Y') if order.date_received else '—' }}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Стоимость:</strong><br>
                                <span class="text-success" id="order-cost-{{ order.id }}">{{ "%.2f ₽"|format(order.final_cost or order.cost_estimate or 0) }}</span>
                            </div>
                            <div class="col-6">
                                <strong>Статус:</strong><br>
                                <span class="badge bg-{{ 'warning' if order.status == 'received' else 'info' if order.status == 'diagnosis' else 'primary' if order.status == 'in_work' else 'danger' if order.status == 'requires_approval' else 'teal' if order.status == 'approved' else 'success' if order.status == 'ready' else 'orange' if order.status == 'parts_order' else 'purple' if order.status == 'parts_ordered' else 'dark' if order.status == 'parts_issued' else 'secondary' if order.status == 'completed' else 'secondary' }} clickable-status" 
                                      onclick="event.stopPropagation(); changeOrderStatus({{ order.id }}, '{{ order.status }}')" 
                                      style="cursor: pointer;" 
                                      title="Нажмите для изменения статуса">
                                    {{ order.get_status_display() }}
                                </span>
                            </div>
                        </div>
                        
                        {% if order.status == 'received' or order.status == 'requires_approval' %}
                        <div class="row mb-2">
                            <div class="col-12 text-center">
                                <button class="btn btn-success btn-sm" onclick="takeToWork({{ order.id }})" title="Взять в работу">
                                    <i class="bi bi-play-circle"></i> Взять в работу
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-light">
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> Создан: {{ order.created_at.strftime('%d.%m.%Y %H:%M') if order.created_at else '—' }}
                        </small>
                    </div>
                </div>
            </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Order Modal -->
<div class="modal fade" id="newOrderModal" tabindex="-1">
    <div class="modal-dialog modal-a4">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Новый заказ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body a4-form-body">
                <form id="newOrderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientType" class="form-label">Тип клиента *</label>
                                <select class="form-select" id="clientType" required onchange="toggleClientFields()">
                                    <option value="">Выберите тип</option>
                                    <option value="individual">Физическое лицо</option>
                                    <option value="legal">Юридическое лицо</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientPhone" class="form-label">Телефон *</label>
                                <input type="tel" class="form-control" id="clientPhone" placeholder="+7 (___) ___-__-__" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientName" class="form-label" id="clientNameLabel">ФИО клиента *</label>
                                <input type="text" class="form-control" id="clientName" placeholder="Введите ФИО клиента" required>
                                <div id="clientSuggestions" class="list-group mt-2" style="display: none;"></div>
                                <div id="clientStatus" class="mt-1" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientAddress" class="form-label">Адрес *</label>
                                <input type="text" class="form-control" id="clientAddress" placeholder="Введите адрес" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Дополнительные поля для юридических лиц -->
                    <div id="legalFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="organizationName" class="form-label">Наименование организации *</label>
                                    <input type="text" class="form-control" id="organizationName" placeholder="Введите наименование организации">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="inn" class="form-label">ИНН организации *</label>
                                    <input type="text" class="form-control" id="inn" placeholder="Введите ИНН организации" maxlength="12">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientEmail" class="form-label">Email (не обязательно)</label>
                                <input type="email" class="form-control" id="clientEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceType" class="form-label">Тип устройства *</label>
                                <input type="text" class="form-control" id="deviceType" placeholder="Введите тип устройства" required>
                                <div id="deviceTypeSuggestions" class="list-group mt-2" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceBrand" class="form-label">Бренд *</label>
                                <input type="text" class="form-control" id="deviceBrand" placeholder="Введите бренд" required>
                                <div id="deviceBrandSuggestions" class="list-group mt-2" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceModel" class="form-label">Модель *</label>
                                <input type="text" class="form-control" id="deviceModel" placeholder="Введите модель" required>
                                <div id="deviceModelSuggestions" class="list-group mt-2" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceSerialNumber" class="form-label">Серийный номер</label>
                                <input type="text" class="form-control" id="deviceSerialNumber" placeholder="Введите серийный номер устройства">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceImei" class="form-label">IMEI (для мобильных устройств)</label>
                                <input type="text" class="form-control" id="deviceImei" placeholder="Введите IMEI устройства">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="problemDescription" class="form-label">Описание проблемы *</label>
                        <textarea class="form-control" id="problemDescription" rows="3" placeholder="Опишите проблему с устройством" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceCondition" class="form-label">Внешнее состояние *</label>
                                <textarea class="form-control" id="deviceCondition" rows="3" placeholder="Опишите внешнее состояние устройства" required></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="completeness" class="form-label">Комплектность *</label>
                                <textarea class="form-control" id="completeness" rows="3" placeholder="Опишите что входит в комплект" required></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="createOrder()">
                    <i class="bi bi-check-circle"></i> Создать заказ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Order Details Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xxl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clipboard-check"></i> Детали заказа <span id="orderDetailId"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetailContent">
                    <!-- Content will be loaded here by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Order Modal -->
<div class="modal fade" id="editOrderModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> Редактировать заказ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderForm">
                    <input type="hidden" id="editOrderId">
                    
                    <!-- Информация о клиенте -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="bi bi-person"></i> Информация о клиенте</h6>
                        </div>
                        <div class="col-md-4">
                            <label for="editClientName" class="form-label">Имя клиента</label>
                            <input type="text" class="form-control" id="editClientName" required>
                        </div>
                        <div class="col-md-4">
                            <label for="editClientPhone" class="form-label">Телефон</label>
                            <input type="tel" class="form-control" id="editClientPhone">
                        </div>
                        <div class="col-md-4">
                            <label for="editClientEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editClientEmail">
                        </div>
                    </div>
                    
                    <!-- Информация об устройстве -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="bi bi-laptop"></i> Информация об устройстве</h6>
                        </div>
                        <div class="col-md-3">
                            <label for="editDeviceType" class="form-label">Тип устройства</label>
                            <input type="text" class="form-control" id="editDeviceType" required>
                        </div>
                        <div class="col-md-3">
                            <label for="editDeviceBrand" class="form-label">Бренд</label>
                            <input type="text" class="form-control" id="editDeviceBrand" required>
                        </div>
                        <div class="col-md-3">
                            <label for="editDeviceModel" class="form-label">Модель</label>
                            <input type="text" class="form-control" id="editDeviceModel" required>
                        </div>
                        <div class="col-md-3">
                            <label for="editDeviceSerial" class="form-label">Серийный номер</label>
                            <input type="text" class="form-control" id="editDeviceSerial">
                        </div>
                    </div>
                    
                    <!-- Информация о заказе -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="bi bi-clipboard-check"></i> Информация о заказе</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="editProblemDescription" class="form-label">Описание проблемы</label>
                            <textarea class="form-control" id="editProblemDescription" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="editDiagnosis" class="form-label">Диагностика</label>
                            <textarea class="form-control" id="editDiagnosis" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="editRepairDescription" class="form-label">Описание ремонта</label>
                            <textarea class="form-control" id="editRepairDescription" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="editNotes" class="form-label">Примечания</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <!-- Финансовая информация -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="bi bi-currency-dollar"></i> Финансовая информация</h6>
                        </div>
                        <div class="col-md-4">
                            <label for="editCostEstimate" class="form-label">Предварительная стоимость (₽)</label>
                            <input type="number" class="form-control" id="editCostEstimate" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                            <label for="editFinalCost" class="form-label">Финальная стоимость (₽)</label>
                            <input type="number" class="form-control" id="editFinalCost" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                            <label for="editPrepayment" class="form-label">Предоплата (₽)</label>
                            <input type="number" class="form-control" id="editPrepayment" step="0.01" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveOrderEdit()">
                    <i class="bi bi-check-circle"></i> Сохранить изменения
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Order Status Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat"></i> Изменить статус заказа
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changeStatusForm">
                    <input type="hidden" id="changeStatusOrderId">
                    <input type="hidden" id="changeStatusOldStatus">
                    
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Новый статус</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Выберите статус</option>
                            <option value="diagnosis">Диагностика</option>
                            <option value="in_work">В работе</option>
                            <option value="requires_approval">Требуется согласование</option>
                            <option value="approved">Согласовано</option>
                            <option value="ready">Готов к выдаче</option>
                            <option value="parts_order">Заказ ЗИП</option>
                            <option value="parts_ordered">ЗИП заказан</option>
                            <option value="parts_issued">ЗИП выдан</option>
                            <option value="completed">Выдано</option>
                            <option value="rejected">Отказ от ремонта</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusComment" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="statusComment" rows="4" placeholder="Опишите детали изменения статуса..."></textarea>
                    </div>
                    
                    <!-- Поле для суммы диагностики (скрыто по умолчанию) -->
                    <div class="mb-3" id="changeStatusDiagnosisCostGroup" style="display: none;">
                        <label for="changeStatusDiagnosisCost" class="form-label">Сумма диагностики (₽)</label>
                        <input type="number" class="form-control" id="changeStatusDiagnosisCost" value="500" min="0" step="10">
                        <div class="form-text">Укажите сумму диагностики для заказов с отказом от ремонта</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveStatusChange()">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Функция показа уведомлений
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function viewOrder(orderId) {
    console.log('viewOrder called with ID:', orderId);
    // Загружаем данные заказа
    fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('Ошибка загрузки заказа: ' + data.error, 'Ошибка', 'error');
                return;
            }
            
            // Заполняем модальное окно данными заказа
            document.getElementById('orderDetailId').textContent = data.id;
            document.getElementById('orderDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person"></i> Информация о клиенте</h6>
                        <p><strong>Имя:</strong> ${data.client.name}</p>
                        <p><strong>Телефон:</strong> ${data.client.phone || 'Не указан'}</p>
                        <p><strong>Email:</strong> ${data.client.email || 'Не указан'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-laptop"></i> Информация об устройстве</h6>
                        <p><strong>Тип:</strong> ${data.device.device_type}</p>
                        <p><strong>Бренд:</strong> ${data.device.brand}</p>
                        <p><strong>Модель:</strong> ${data.device.model}</p>
                        <p><strong>Серийный номер:</strong> ${data.device.serial_number || 'Не указан'}</p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-clipboard-check"></i> Информация о заказе</h6>
                        <p><strong>Статус:</strong> <span class="badge bg-${getStatusColor(data.status)}">${data.status_display}</span></p>
                        <p><strong>Дата приема:</strong> ${data.date_received ? new Date(data.date_received).toLocaleDateString('ru-RU') : 'Не указана'}</p>
                        <p><strong>Проблема:</strong> ${data.problem_description || 'Не указана'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-currency-dollar"></i> Финансовая информация</h6>
                        <p><strong>Предварительная стоимость:</strong> ${data.cost_estimate ? data.cost_estimate + ' ₽' : 'Не указана'}</p>
                        <p><strong>Финальная стоимость:</strong> ${data.final_cost ? data.final_cost + ' ₽' : 'Не указана'}</p>
                        <p><strong>Предоплата:</strong> ${data.prepayment ? data.prepayment + ' ₽' : 'Не указана'}</p>
                    </div>
                </div>
                ${data.diagnosis ? `<hr><h6><i class="bi bi-search"></i> Диагностика</h6><p>${data.diagnosis}</p>` : ''}
                ${data.repair_description ? `<hr><h6><i class="bi bi-tools"></i> Описание ремонта</h6><p>${data.repair_description}</p>` : ''}
                ${data.notes ? `<hr><h6><i class="bi bi-sticky"></i> Примечания</h6><p>${data.notes}</p>` : ''}
                <hr>
                <h6><i class="bi bi-clock-history"></i> История изменений статусов</h6>
                <div id="orderStatusHistory">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="text-muted mt-2">Загрузка истории...</p>
                    </div>
                </div>
            `;
            
            // Показываем модальное окно
            new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
            
            // Загружаем историю статусов
            loadOrderStatusHistory(orderId);
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showAlert('Ошибка загрузки заказа', 'Ошибка', 'error');
        });
}

function editOrder(orderId) {
    console.log('editOrder called with ID:', orderId);
    // Загружаем данные заказа для редактирования
    fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('Ошибка загрузки заказа: ' + data.error, 'Ошибка', 'error');
                return;
            }
            
            // Заполняем форму редактирования
            document.getElementById('editOrderId').value = orderId;
            document.getElementById('editClientName').value = data.client.name;
            document.getElementById('editClientPhone').value = data.client.phone || '';
            document.getElementById('editClientEmail').value = data.client.email || '';
            document.getElementById('editDeviceType').value = data.device.device_type;
            document.getElementById('editDeviceBrand').value = data.device.brand;
            document.getElementById('editDeviceModel').value = data.device.model;
            document.getElementById('editDeviceSerial').value = data.device.serial_number || '';
            document.getElementById('editProblemDescription').value = data.problem_description || '';
            document.getElementById('editDiagnosis').value = data.diagnosis || '';
            document.getElementById('editRepairDescription').value = data.repair_description || '';
            document.getElementById('editCostEstimate').value = data.cost_estimate || '';
            document.getElementById('editFinalCost').value = data.final_cost || '';
            document.getElementById('editPrepayment').value = data.prepayment || '';
            document.getElementById('editNotes').value = data.notes || '';
            
            // Показываем модальное окно редактирования
            new bootstrap.Modal(document.getElementById('editOrderModal')).show();
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showAlert('Ошибка загрузки заказа', 'Ошибка', 'error');
        });
}

function changeStatus(orderId) {
    console.log('changeStatus called with ID:', orderId);
    // Загружаем текущий статус заказа
    fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('Ошибка загрузки заказа: ' + data.error, 'Ошибка', 'error');
                return;
            }
            
            // Заполняем форму изменения статуса
            document.getElementById('changeStatusOrderId').value = orderId;
            document.getElementById('changeStatusOldStatus').value = data.status;
            document.getElementById('newStatus').value = '';
            document.getElementById('statusComment').value = '';
            
            // Скрываем поле суммы диагностики по умолчанию
            document.getElementById('changeStatusDiagnosisCostGroup').style.display = 'none';
            
            // Показываем модальное окно
            new bootstrap.Modal(document.getElementById('changeStatusModal')).show();
            
            // Добавляем обработчик для выпадающего списка статусов
            document.getElementById('newStatus').addEventListener('change', function() {
                const selectedStatus = this.value;
                const diagnosisCostGroup = document.getElementById('changeStatusDiagnosisCostGroup');
                
                if (selectedStatus === 'completed') {
                    // Проверяем, есть ли в истории статус "Отказ от ремонта"
                    fetch(`/api/orders/${orderId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.order && data.order.status_history) {
                                const hasRejectionStatus = data.order.status_history.some(entry => 
                                    entry.new_status === 'rejected'
                                );
                                
                                if (hasRejectionStatus) {
                                    diagnosisCostGroup.style.display = 'block';
                                } else {
                                    diagnosisCostGroup.style.display = 'none';
                                }
                            } else {
                                diagnosisCostGroup.style.display = 'none';
                            }
                        })
                        .catch(() => {
                            diagnosisCostGroup.style.display = 'none';
                        });
                } else {
                    diagnosisCostGroup.style.display = 'none';
                }
            });
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showAlert('Ошибка загрузки заказа', 'Ошибка', 'error');
        });
}

function getStatusColor(status) {
    const statusColors = {
        'received': 'warning',
        'diagnosis': 'info', 
        'in_work': 'primary',
        'requires_approval': 'danger',
        'approved': 'teal',
        'ready': 'success',
        'parts_order': 'orange',
        'parts_ordered': 'purple',
        'parts_issued': 'dark',
        'completed': 'secondary',
        'rejected': 'red'
    };
    return statusColors[status] || 'secondary';
}

function loadOrderStatusHistory(orderId) {
    fetch(`/api/orders/${orderId}/status-history`)
        .then(response => response.json())
        .then(async data => {
            const historyContainer = document.getElementById('orderStatusHistory');
            
            // Получаем сохраненные АВР для этого заказа
            // Сначала нужно найти устройство, связанное с заказом
            let deviceId = null;
            try {
                const orderResponse = await fetch(`/api/orders/${orderId}`);
                const orderData = await orderResponse.json();
                if (orderData && orderData.device_id) {
                    deviceId = orderData.device_id;
                }
            } catch (error) {
                console.error('Ошибка загрузки данных заказа:', error);
            }
            
            const workReports = JSON.parse(localStorage.getItem('workReports') || '{}');
            const orderReports = deviceId ? (workReports[deviceId] || []) : [];
            
            // Объединяем историю статусов и АВР
            const allEntries = [];
            
            // Добавляем записи истории статусов
            if (data && data.length > 0) {
                data.forEach(entry => {
                    allEntries.push({
                        type: 'status',
                        data: entry,
                        timestamp: new Date(entry.created_at)
                    });
                });
            }
            
            // Добавляем АВР
            orderReports.forEach(report => {
                // Убеждаемся, что у АВР есть необходимые поля
                if (!report.parts) report.parts = [];
                if (!report.services) report.services = [];
                
                allEntries.push({
                    type: 'work_report',
                    data: report,
                    timestamp: new Date(report.created_at)
                });
            });
            
            // Сортируем по времени (новые сверху)
            allEntries.sort((a, b) => b.timestamp - a.timestamp);
            
            if (allEntries.length === 0) {
                historyContainer.innerHTML = '<p class="text-muted">Нет изменений статусов</p>';
                return;
            }
            
            const historyHTML = allEntries.map(entry => {
                if (entry.type === 'status') {
                    const statusData = entry.data;
                    const statusColors = {
                        'received': 'warning',
                        'diagnosis': 'info', 
                        'in_work': 'primary',
                        'requires_approval': 'danger',
                        'approved': 'teal',
                        'ready': 'success',
                        'parts_order': 'orange',
                        'parts_ordered': 'purple',
                        'parts_issued': 'dark',
                        'completed': 'secondary',
                        'rejected': 'red'
                    };
                    const color = statusColors[statusData.new_status] || 'secondary';
                    return `
                        <tr>
                            <td>${entry.timestamp.toLocaleString('ru-RU')}</td>
                            <td>${statusData.user_name}</td>
                            <td><span class="badge bg-${color}">${statusData.new_status_display}</span></td>
                            <td style="white-space: pre-line;">${statusData.comment || '-'}</td>
                        </tr>
                    `;
                } else if (entry.type === 'work_report') {
                    const reportData = entry.data;
                    return `
                        <tr class="table-success">
                            <td>${entry.timestamp.toLocaleString('ru-RU')}</td>
                            <td>
                                <strong><i class="bi bi-file-text text-success"></i> Акт выполненных работ</strong>
                                <br><span class="badge bg-success">АВР #${reportData.id}</span>
                            </td>
                            <td>
                                <strong>Стоимость:</strong> ${reportData.total_cost} ₽<br>
                                <strong>Описание:</strong> ${reportData.work_description ? reportData.work_description.substring(0, 50) + (reportData.work_description.length > 50 ? '...' : '') : 'Без описания'}<br>
                                ${reportData.parts && reportData.parts.length > 0 ? `<strong>Запчасти:</strong> ${reportData.parts.length} шт.<br>` : ''}
                                ${reportData.services && reportData.services.length > 0 ? `<strong>Услуги:</strong> ${reportData.services.length} шт.` : ''}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewWorkReportFromOrder('${reportData.id}')" title="Просмотр">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="printWorkReportFromOrder('${reportData.id}')" title="Печать">
                                        <i class="bi bi-printer"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteWorkReportFromOrder('${reportData.id}', ${orderId})" title="Удалить">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }).join('');
            
            historyContainer.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Пользователь</th>
                                <th>Статус</th>
                                <th>Комментарий</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${historyHTML}
                        </tbody>
                    </table>
                </div>
            `;
        })
        .catch(error => {
            console.error('Ошибка загрузки истории статусов:', error);
            document.getElementById('orderStatusHistory').innerHTML = '<p class="text-danger">Ошибка загрузки истории</p>';
        });
}

function saveOrderEdit() {
    const orderId = document.getElementById('editOrderId').value;
    
    // Собираем данные формы
    const orderData = {
        // Данные клиента
        client_name: document.getElementById('editClientName').value,
        client_phone: document.getElementById('editClientPhone').value,
        client_email: document.getElementById('editClientEmail').value,
        
        // Данные устройства
        device_type: document.getElementById('editDeviceType').value,
        device_brand: document.getElementById('editDeviceBrand').value,
        device_model: document.getElementById('editDeviceModel').value,
        device_serial: document.getElementById('editDeviceSerial').value,
        
        // Данные заказа
        problem_description: document.getElementById('editProblemDescription').value,
        diagnosis: document.getElementById('editDiagnosis').value,
        repair_description: document.getElementById('editRepairDescription').value,
        notes: document.getElementById('editNotes').value,
        
        // Финансовая информация
        cost_estimate: document.getElementById('editCostEstimate').value,
        final_cost: document.getElementById('editFinalCost').value,
        prepayment: document.getElementById('editPrepayment').value
    };
    
    // Валидация обязательных полей
    if (!orderData.client_name || !orderData.device_type || !orderData.device_brand || !orderData.device_model) {
        showAlert('Пожалуйста, заполните все обязательные поля', 'Ошибка', 'error');
        return;
    }
    
    fetch(`/api/orders/${orderId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Заказ успешно обновлен', 'Успех', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
            location.reload();
        } else {
            showAlert('Ошибка: ' + data.message, 'Ошибка', 'error');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showAlert('Ошибка сохранения изменений', 'Ошибка', 'error');
    });
}

function saveStatusChange() {
    const orderId = document.getElementById('changeStatusOrderId').value;
    const newStatus = document.getElementById('newStatus').value;
    const comment = document.getElementById('statusComment').value;
    const diagnosisCost = document.getElementById('changeStatusDiagnosisCost').value || 500;
    
    if (!newStatus) {
        showAlert('Пожалуйста, выберите новый статус', 'Ошибка', 'error');
        return;
    }
    
    fetch(`/api/orders/${orderId}/change-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            new_status: newStatus,
            comment: comment,
            diagnosis_cost: parseFloat(diagnosisCost)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Статус успешно изменен', 'Успех', 'success');
            bootstrap.Modal.getInstance(document.getElementById('changeStatusModal')).hide();
            location.reload();
        } else {
            showAlert('Ошибка: ' + data.message, 'Ошибка', 'error');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showAlert('Ошибка изменения статуса', 'Ошибка', 'error');
    });
}

let selectedClientId = null;
let isNewClient = false;

// Маска для телефона
function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, ''); // Убираем все нецифровые символы
    
    if (value.length === 0) {
        input.value = '';
        return;
    }
    
    if (value.startsWith('8')) {
        value = '7' + value.substring(1);
    }
    
    if (!value.startsWith('7')) {
        value = '7' + value;
    }
    
    if (value.length > 11) {
        value = value.substring(0, 11);
    }
    
    let formatted = '+7';
    if (value.length > 1) {
        formatted += ' (' + value.substring(1, 4);
    }
    if (value.length >= 4) {
        formatted += ') ' + value.substring(4, 7);
    }
    if (value.length >= 7) {
        formatted += ' ' + value.substring(7, 9);
    }
    if (value.length >= 9) {
        formatted += ' ' + value.substring(9, 11);
    }
    
    input.value = formatted;
}

// Применяем маску к полю телефона
document.getElementById('clientPhone').addEventListener('input', function() {
    formatPhoneNumber(this);
});

// Переключение полей в зависимости от типа клиента
function toggleClientFields() {
    const clientType = document.getElementById('clientType').value;
    const nameLabel = document.getElementById('clientNameLabel');
    const nameInput = document.getElementById('clientName');
    const legalFields = document.getElementById('legalFields');
    const organizationName = document.getElementById('organizationName');
    const inn = document.getElementById('inn');
    
    if (clientType === 'individual') {
        nameLabel.textContent = 'ФИО клиента *';
        nameInput.placeholder = 'Введите ФИО клиента';
        legalFields.style.display = 'none';
        organizationName.required = false;
        inn.required = false;
    } else if (clientType === 'legal') {
        nameLabel.textContent = 'Контактное лицо *';
        nameInput.placeholder = 'Введите ФИО контактного лица';
        legalFields.style.display = 'block';
        organizationName.required = true;
        inn.required = true;
    } else {
        legalFields.style.display = 'none';
        organizationName.required = false;
        inn.required = false;
    }
}

// Автозаполнение типов устройств
document.getElementById('deviceType').addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
        hideDeviceTypeSuggestions();
        return;
    }
    searchDeviceTypes(query);
});

// Автозаполнение брендов
document.getElementById('deviceBrand').addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
        hideDeviceBrandSuggestions();
        return;
    }
    searchDeviceBrands(query);
});

// Автозаполнение моделей
document.getElementById('deviceModel').addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
        hideDeviceModelSuggestions();
        return;
    }
    searchDeviceModels(query);
});

// Автозаполнение клиентов
document.getElementById('clientName').addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
        hideSuggestions();
        return;
    }
    
    searchClients(query);
});

// Поиск клиентов
async function searchClients(query) {
    try {
        const response = await fetch(`/api/clients/search?q=${encodeURIComponent(query)}`);
        const clients = await response.json();
        showSuggestions(clients);
    } catch (error) {
        console.error('Ошибка поиска клиентов:', error);
    }
}

// Показать предложения
function showSuggestions(clients) {
    const suggestionsDiv = document.getElementById('clientSuggestions');
    const statusDiv = document.getElementById('clientStatus');
    
    if (clients.length === 0) {
        suggestionsDiv.style.display = 'none';
        statusDiv.innerHTML = '<span class="text-info"><i class="bi bi-person-plus"></i> Новый клиент</span>';
        statusDiv.style.display = 'block';
        isNewClient = true;
        selectedClientId = null;
        return;
    }
    
    suggestionsDiv.innerHTML = '';
    clients.forEach(client => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${client.name}</h6>
                <small>${client.phone}</small>
            </div>
            <p class="mb-1">${client.address}</p>
            <small>Клиент с ${new Date(client.created_at).toLocaleDateString()}</small>
        `;
        item.addEventListener('click', () => selectClient(client));
        suggestionsDiv.appendChild(item);
    });
    
    suggestionsDiv.style.display = 'block';
    statusDiv.style.display = 'none';
}

// Выбрать клиента
function selectClient(client) {
    document.getElementById('clientName').value = client.name;
    document.getElementById('clientPhone').value = client.phone;
    // Применяем форматирование к телефону
    formatPhoneNumber(document.getElementById('clientPhone'));
    document.getElementById('clientAddress').value = client.address;
    document.getElementById('clientEmail').value = client.email || '';
    
    selectedClientId = client.id;
    isNewClient = false;
    
    hideSuggestions();
    
    const statusDiv = document.getElementById('clientStatus');
    statusDiv.innerHTML = '<span class="text-success"><i class="bi bi-person-check"></i> Постоянный клиент</span>';
    statusDiv.style.display = 'block';
}

// Скрыть предложения
function hideSuggestions() {
    document.getElementById('clientSuggestions').style.display = 'none';
}

// Поиск типов устройств
async function searchDeviceTypes(query) {
    try {
        const response = await fetch(`/api/devices/types/search?q=${encodeURIComponent(query)}`);
        const types = await response.json();
        showDeviceTypeSuggestions(types);
    } catch (error) {
        console.error('Ошибка поиска типов устройств:', error);
    }
}

// Поиск брендов
async function searchDeviceBrands(query) {
    try {
        const response = await fetch(`/api/devices/brands/search?q=${encodeURIComponent(query)}`);
        const brands = await response.json();
        showDeviceBrandSuggestions(brands);
    } catch (error) {
        console.error('Ошибка поиска брендов:', error);
    }
}

// Поиск моделей
async function searchDeviceModels(query) {
    try {
        const response = await fetch(`/api/devices/models/search?q=${encodeURIComponent(query)}`);
        const models = await response.json();
        showDeviceModelSuggestions(models);
    } catch (error) {
        console.error('Ошибка поиска моделей:', error);
    }
}

// Показать предложения типов устройств
function showDeviceTypeSuggestions(types) {
    const suggestionsDiv = document.getElementById('deviceTypeSuggestions');
    suggestionsDiv.innerHTML = '';
    types.forEach(type => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = type;
        item.addEventListener('click', () => {
            document.getElementById('deviceType').value = type;
            hideDeviceTypeSuggestions();
        });
        suggestionsDiv.appendChild(item);
    });
    suggestionsDiv.style.display = 'block';
}

// Показать предложения брендов
function showDeviceBrandSuggestions(brands) {
    const suggestionsDiv = document.getElementById('deviceBrandSuggestions');
    suggestionsDiv.innerHTML = '';
    brands.forEach(brand => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = brand;
        item.addEventListener('click', () => {
            document.getElementById('deviceBrand').value = brand;
            hideDeviceBrandSuggestions();
        });
        suggestionsDiv.appendChild(item);
    });
    suggestionsDiv.style.display = 'block';
}

// Показать предложения моделей
function showDeviceModelSuggestions(models) {
    const suggestionsDiv = document.getElementById('deviceModelSuggestions');
    suggestionsDiv.innerHTML = '';
    models.forEach(model => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = model;
        item.addEventListener('click', () => {
            document.getElementById('deviceModel').value = model;
            hideDeviceModelSuggestions();
        });
        suggestionsDiv.appendChild(item);
    });
    suggestionsDiv.style.display = 'block';
}

// Скрыть предложения
function hideDeviceTypeSuggestions() {
    document.getElementById('deviceTypeSuggestions').style.display = 'none';
}

function hideDeviceBrandSuggestions() {
    document.getElementById('deviceBrandSuggestions').style.display = 'none';
}

function hideDeviceModelSuggestions() {
    document.getElementById('deviceModelSuggestions').style.display = 'none';
}

function createOrder() {
    const formData = {
        client_type: document.getElementById('clientType').value,
        client_name: document.getElementById('clientName').value,
        client_phone: document.getElementById('clientPhone').value,
        client_address: document.getElementById('clientAddress').value,
        client_email: document.getElementById('clientEmail').value,
        organization_name: document.getElementById('organizationName').value,
        inn: document.getElementById('inn').value,
        device_type: document.getElementById('deviceType').value,
        device_brand: document.getElementById('deviceBrand').value,
        device_model: document.getElementById('deviceModel').value,
        device_serial_number: document.getElementById('deviceSerialNumber').value,
        device_imei: document.getElementById('deviceImei').value,
        device_condition: document.getElementById('deviceCondition').value,
        problem_description: document.getElementById('problemDescription').value,
        completeness: document.getElementById('completeness').value
    };
    
    fetch('/api/orders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка создания заказа');
    });
}

// currentPrintOrderId объявлена в main.js

// Функция "Взять в работу"
function takeToWork(orderId) {
    // Показываем красивое модальное окно подтверждения
    document.getElementById('confirmOrderId').textContent = orderId;
    new bootstrap.Modal(document.getElementById('confirmTakeToWorkModal')).show();
}

// Функция подтверждения "Взять в работу"
function confirmTakeToWork() {
    const orderId = document.getElementById('confirmOrderId').textContent;
    
    fetch(`/api/orders/${orderId}/change-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            new_status: 'in_work',
            comment: 'Взят в работу'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            bootstrap.Modal.getInstance(document.getElementById('confirmTakeToWorkModal')).hide();
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка при взятии заказа в работу');
    });
}


// Показать акт приема
function showAcceptanceAct(orderId) {
    currentPrintOrderId = orderId;
    
    // Показываем модальное окно предварительного просмотра
    document.getElementById('previewDocumentType').textContent = 'Акт приема';
    document.getElementById('previewDocumentTypeValue').value = 'acceptance_act';
    
    // Показываем загрузку
    document.getElementById('documentPreviewContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Загрузка акта приема...</p>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('documentPreviewModal')).show();
    
    // Загружаем данные заказа
    fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(orderData => {
            if (orderData.error) {
                document.getElementById('documentPreviewContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Ошибка загрузки данных заказа: ${orderData.error}
                    </div>
                `;
                return;
            }
            
            // Генерируем акт приема
            const acceptanceActHTML = generateAcceptanceAct(orderData);
            document.getElementById('documentPreviewContent').innerHTML = acceptanceActHTML;
        })
        .catch(error => {
            console.error('Ошибка загрузки данных заказа:', error);
            document.getElementById('documentPreviewContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Ошибка загрузки данных заказа: ${error.message}
                </div>
            `;
        });
}

// Показать предварительный просмотр документа
function printDocument(documentType) {
    if (!currentPrintOrderId) {
        alert('Ошибка: не выбран ID заказа');
        return;
    }
    
    // Закрываем модальное окно выбора типа
    bootstrap.Modal.getInstance(document.getElementById('printDocumentModal')).hide();
    
    // Показываем модальное окно предварительного просмотра
    document.getElementById('previewDocumentType').textContent = getDocumentTypeName(documentType);
    document.getElementById('previewDocumentTypeValue').value = documentType;
    
    // Показываем загрузку
    document.getElementById('documentPreviewContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Загрузка документа...</p>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('documentPreviewModal')).show();
    
    // Загружаем данные заказа и историю статусов
    Promise.all([
        fetch(`/api/orders/${currentPrintOrderId}`).then(response => response.json()),
        fetch(`/api/orders/${currentPrintOrderId}/status-history`).then(response => response.json())
    ])
    .then(([orderData, statusHistory]) => {
        if (orderData.error) {
            document.getElementById('documentPreviewContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Ошибка: ${orderData.error}
                </div>
            `;
            return;
        }
        
        // Добавляем историю статусов к данным заказа
        orderData.status_history = statusHistory;
        
        let printContent = '';
        
        switch(documentType) {
            case 'acceptance':
                printContent = generateAcceptanceAct(orderData);
                break;
            case 'completed_work':
                printContent = generateCompletedWorkAct(orderData);
                break;
            case 'unrepairable':
                printContent = generateUnrepairableAct(orderData);
                break;
            default:
                document.getElementById('documentPreviewContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Неизвестный тип документа
                    </div>
                `;
                return;
        }
        
        // Показываем предварительный просмотр
        document.getElementById('documentPreviewContent').innerHTML = printContent;
    })
    .catch(error => {
        console.error('Ошибка:', error);
        document.getElementById('documentPreviewContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Ошибка загрузки информации о заказе
            </div>
        `;
    });
}

// Функция для получения названия типа документа
function getDocumentTypeName(documentType) {
    const names = {
        'acceptance': 'АКТ приема',
        'completed_work': 'АКТ выполненных работ',
        'unrepairable': 'АКТ о неремонтопригодности'
    };
    return names[documentType] || 'Документ';
}

// Функция печати из предварительного просмотра
function printFromPreview() {
    let documentHTML = document.getElementById('documentPreviewContent').innerHTML;
    
    // Обрабатываем поле ввода для суммы диагностики
    const diagnosisCostInput = document.getElementById('diagnosisCost');
    if (diagnosisCostInput) {
        const diagnosisCost = diagnosisCostInput.value || 500;
        // Заменяем поле ввода на статический текст
        documentHTML = documentHTML.replace(
            /Диагностика - <input[^>]*> ₽/g,
            `Диагностика - ${diagnosisCost} ₽`
        );
        // Обновляем общую стоимость
        documentHTML = documentHTML.replace(
            /<div class="finance-value" id="totalCost">\d+ ₽<\/div>/g,
            `<div class="finance-value" id="totalCost">${diagnosisCost} ₽</div>`
        );
    }
    
    // Удаляем кнопку "Сохранить" из HTML для печати
    documentHTML = documentHTML.replace(
        /<button[^>]*id="saveDiagnosisCost"[^>]*>.*?<\/button>/g,
        ''
    );
    // Также удаляем кнопку "Сохранить" по тексту, если она осталась
    documentHTML = documentHTML.replace(
        /<button[^>]*>Сохранить<\/button>/g,
        ''
    );
    
    // Создаем новое окно для печати
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Печать документа</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .document-container { max-width: 800px; margin: 0 auto; }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="document-container">
                ${documentHTML}
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    
    // Ждем загрузки и печатаем
    printWindow.onload = function() {
        printWindow.print();
        
        // Обработчик события после печати
        printWindow.onafterprint = function() {
            printWindow.close();
            // Закрываем модальное окно предварительного просмотра
            const modal = bootstrap.Modal.getInstance(document.getElementById('documentPreviewModal'));
            if (modal) {
                modal.hide();
            }
        };
        
        // Если браузер не поддерживает onafterprint, закрываем через небольшую задержку
        setTimeout(() => {
            if (!printWindow.closed) {
                printWindow.close();
                const modal = bootstrap.Modal.getInstance(document.getElementById('documentPreviewModal'));
                if (modal) {
                    modal.hide();
                }
            }
        }, 2000);
    };
}

// Генерация АКТА ПРИЕМА
function generateAcceptanceAct(data) {
    const currentDate = new Date().toLocaleDateString('ru-RU');
    const currentTime = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    
    return `
        <html>
        <head>
            <title>АКТ приема-передачи техники в ремонт №${data.id}</title>
            <style>
                body { 
                    font-family: 'Times New Roman', serif; 
                    font-size: 10pt; 
                    line-height: 1.2; 
                    margin: 0; 
                    padding: 10px; 
                    background: white;
                    max-width: 210mm;
                    margin: 0 auto;
                }
                
                .header { 
                    text-align: center; 
                    margin-bottom: 15px; 
                    border-bottom: 1px solid #000;
                    padding-bottom: 8px;
                }
                
                .header h1 { 
                    font-size: 12pt; 
                    font-weight: bold; 
                    margin: 0 0 5px 0; 
                    text-transform: uppercase; 
                }
                
                .header h2 { 
                    font-size: 10pt; 
                    font-weight: bold; 
                    margin: 0 0 10px 0; 
                }
                
                .document-info { 
                    text-align: right; 
                    margin-bottom: 15px; 
                }
                
                .parties { 
                    margin-bottom: 15px; 
                }
                
                .party { 
                    margin-bottom: 10px; 
                }
                
                .party-title { 
                    font-weight: bold; 
                    margin-bottom: 5px; 
                }
                
                .party-info { 
                    margin-left: 15px; 
                }
                
                .equipment-table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 20px 0; 
                }
                
                .equipment-table th,
                .equipment-table td { 
                    border: 1px solid #000; 
                    padding: 8px; 
                    text-align: left; 
                    vertical-align: top; 
                }
                
                .equipment-table th { 
                    background-color: #f0f0f0; 
                    font-weight: bold; 
                    text-align: center; 
                }
                
                .conditions { 
                    margin: 15px 0; 
                }
                
                .conditions h3 { 
                    font-size: 10pt; 
                    font-weight: bold; 
                    margin: 10px 0 5px 0; 
                }
                
                .conditions ul { 
                    margin: 5px 0; 
                    padding-left: 15px; 
                }
                
                .conditions p { 
                    margin: 3px 0; 
                }
                
                .signatures { 
                    margin-top: 15px; 
                }
                
                .signature-block { 
                    display: inline-block; 
                    width: 45%; 
                    margin: 10px 2.5%; 
                    vertical-align: top; 
                }
                
                .signature-line { 
                    border-bottom: 1px solid #000; 
                    height: 20px; 
                    margin: 5px 0; 
                }
                
                @media print {
                    body { 
                        margin: 0; 
                        padding: 8px; 
                        font-size: 9pt;
                        line-height: 1.1;
                    }
                    .header { margin-bottom: 10px; }
                    .document-info { margin-bottom: 10px; }
                    .parties { margin-bottom: 10px; }
                    .party { margin-bottom: 8px; }
                    .conditions { margin: 10px 0; }
                    .conditions h3 { margin: 8px 0 4px 0; }
                    .conditions ul { margin: 3px 0; }
                    .conditions p { margin: 2px 0; }
                    .signatures { margin-top: 10px; }
                    .signature-block { margin: 8px 2.5%; }
                    .signature-line { height: 15px; margin: 3px 0; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>АКТ приема-передачи техники в ремонт</h1>
                <h2>№ ${data.id} от ${currentDate}</h2>
            </div>
            
            <div class="document-info">
                <strong>г. ${data.service && data.service.address ? data.service.address.split(',')[0] : 'Город'}</strong><br>
                <strong>"${currentDate.split('.')[0]}" ${new Date().toLocaleDateString('ru-RU', {month: 'long', year: 'numeric'})} г.</strong>
            </div>
            
            <div class="parties">
                <div class="party">
                    <div class="party-title">От Исполнителя:</div>
                    <div class="party-info">
                        <strong>${data.service ? data.service.name : 'Сервисный центр'}</strong>, в лице ${data.master ? data.master.full_name : 'Представитель'},<br>
                        Действующего на основании должностных полномочий,<br>
                        ${data.service && data.service.legal_address ? `Юридический адрес: ${data.service.legal_address},<br>` : ''}
                        ${data.service && data.service.address ? `Фактический адрес: ${data.service.address},<br>` : ''}
                        ${data.service && data.service.phone ? `Телефон: ${data.service.phone},<br>` : ''}
                        ${data.service && data.service.email ? `Email: ${data.service.email},<br>` : ''}
                        ${data.service && data.service.inn ? `ИНН: ${data.service.inn},<br>` : ''}
                        ${data.service && data.service.ogrn ? `ОГРН: ${data.service.ogrn}` : ''}
                    </div>
                </div>
                
                <div class="party">
                    <div class="party-title">От Заказчика:</div>
                    <div class="party-info">
                        <strong>${data.client && data.client.name ? data.client.name : 'Клиент'}</strong>,<br>
                        ${data.client && data.client.phone ? `Телефон: ${data.client.phone},<br>` : ''}
                        ${data.client && data.client.address ? `Адрес: ${data.client.address},<br>` : ''}
                        ${data.client && data.client.email ? `Email: ${data.client.email}` : ''}
                    </div>
                </div>
            </div>
            
            <p><strong>составили настоящий Акт о нижеследующем:</strong></p>
            
            <div class="conditions">
                <h3>1. Предмет передачи:</h3>
                <p><strong>Наименование техники:</strong> ${data.device ? (data.device.device_type || 'Не указано') : 'Не указано'}</p>
                <p><strong>Марка, модель:</strong> ${data.device ? ((data.device.brand || '') + ' ' + (data.device.model || '') || 'Не указано') : 'Не указано'}</p>
                <p><strong>Серийный номер:</strong> ${data.device ? (data.device.serial_number || 'Не указано') : 'Не указано'}</p>
                <p><strong>Комплектация:</strong> ${data.device ? (data.device.completeness || 'Не указано') : 'Не указано'}</p>
                <p><strong>Внешнее состояние:</strong> ${data.device ? (data.device.condition || 'Не указано') : 'Не указано'}</p>
                <p><strong>Описание неисправности:</strong> ${data.problem_description || 'Не указано'}</p>
                
                <h3>2. Условия ремонта:</h3>
                <ul>
                    <li><strong>Сроки выполнения диагностики до:</strong> 7 рабочих дней</li>
                    <li><strong>Гарантийные обязательства Исполнителя:</strong> 30 дней на выполненные работы</li>
                </ul>
                
                <h3>3. Прочие условия:</h3>
                <ul>
                    <li>Заказчик подтверждает отсутствие коммерческой тайны в передаваемой технике.</li>
                    <li>Исполнитель не несет ответственности за сохранность данных на носителях.</li>
                    <li>При обнаружении скрытых дефектов стоимость и сроки могут быть пересмотрены.</li>
                    ${data.notes ? `<li><strong>Дополнительно:</strong> ${data.notes}</li>` : ''}
                </ul>
            </div>
            
            <div class="signatures" style="display: flex; justify-content: space-between; margin-top: 20px;">
                <div class="signature-block" style="width: 45%;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <strong style="margin-right: 10px;">Исполнитель:</strong>
                        <div class="signature-line" style="flex: 1; height: 20px; border-bottom: 1px solid #000;"></div>
                    </div>
                    <div style="text-align: center; font-size: 10pt;">
                        ${data.master ? data.master.full_name : 'Представитель сервисного центра'}
                    </div>
                    <div style="text-align: center; font-size: 10pt; margin-top: 5px;">
                        (подпись) / (ФИО)
                    </div>
                </div>
                
                <div class="signature-block" style="width: 45%;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <strong style="margin-right: 10px;">Заказчик:</strong>
                        <div class="signature-line" style="flex: 1; height: 20px; border-bottom: 1px solid #000;"></div>
                    </div>
                    <div style="text-align: center; font-size: 10pt;">
                        ${data.client && data.client.name ? data.client.name : 'Клиент'}
                    </div>
                    <div style="text-align: center; font-size: 10pt; margin-top: 5px;">
                        (подпись) / (ФИО)
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 8pt; color: #666;">
                <p style="margin: 2px 0;"><strong>Примечание:</strong> Настоящий акт составлен в двух экземплярах, имеющих одинаковую юридическую силу, по одному для каждой из сторон.</p>
                <p style="margin: 2px 0;"><strong>Дата создания:</strong> ${currentDate} ${currentTime}</p>
                <p style="margin: 2px 0;"><strong>Создал:</strong> ${data.master ? data.master.full_name : 'Система'}</p>
            </div>
        </body>
        </html>
    `;
}

// Генерация АКТА ВЫПОЛНЕННЫХ РАБОТ
function generateCompletedWorkAct(data, diagnosisCost = null) {
    // Используем сохраненную сумму диагностики из базы данных, если она есть
    if (diagnosisCost === null) {
        diagnosisCost = data.diagnosis_cost || 500;
    }
    // Извлекаем информацию о согласованных ЗИП и услугах из истории статусов
    let approvedParts = [];
    let approvedServices = [];
    let diagnosis = '';
    let workDescription = '';
    
    // Проверяем, есть ли статус "Отказ от ремонта"
    const hasRejectionStatus = data.status_history && data.status_history.some(entry => 
        entry.new_status === 'rejected'
    );
    
    if (data.status_history && data.status_history.length > 0) {
        // Если есть статус "Отказ от ремонта", не показываем заказанный ЗИП
        if (!hasRejectionStatus) {
            // Ищем записи с комментариями о заказе ЗИП
            const zipComments = data.status_history.filter(entry => 
                entry.comment && entry.comment.includes('Заказ ЗИП создан')
            );
            
            if (zipComments.length > 0) {
                // Берем последний комментарий о заказе ЗИП
                const latestZipComment = zipComments[0].comment;
                
                // Парсим комментарий для извлечения запчастей и услуг
                const lines = latestZipComment.split('\n');
                let currentSection = '';
                
                for (const line of lines) {
                    if (line.includes('Запчасти:')) {
                        currentSection = 'parts';
                        continue;
                    } else if (line.includes('Услуги:')) {
                        currentSection = 'services';
                        continue;
                    } else if (line.includes('Примечания:')) {
                        currentSection = 'notes';
                        continue;
                    } else if (line.includes('Общая стоимость:')) {
                        currentSection = 'total';
                        continue;
                    }
                    
                    if (currentSection === 'parts' && line.trim().startsWith('•')) {
                        approvedParts.push(line.trim().substring(1).trim());
                    } else if (currentSection === 'services' && line.trim().startsWith('•')) {
                        approvedServices.push(line.trim().substring(1).trim());
                    }
                }
            }
        }
        
        // Ищем запись о диагностике в истории статусов
        const diagnosisEntry = data.status_history.find(entry => 
            entry.new_status === 'diagnosis' && entry.comment
        );
        
        if (diagnosisEntry) {
            diagnosis = diagnosisEntry.comment;
        }
        
        // Ищем запись о готовности к выдаче в истории статусов
        const readyEntry = data.status_history.find(entry => 
            entry.new_status === 'ready' && entry.comment
        );
        
        if (readyEntry) {
            workDescription = readyEntry.comment;
        }
        
        // Если есть статус "Отказ от ремонта", автоматически добавляем услугу "Диагностика" с возможностью редактирования
        if (hasRejectionStatus) {
            approvedServices.push(`Диагностика - <input type="number" id="diagnosisCost" value="${diagnosisCost}" min="0" step="10" style="width: 80px; border: 1px solid #ccc; padding: 2px; border-radius: 3px;"> ₽ <button type="button" id="saveDiagnosisCost" onclick="saveDiagnosisCost(${data.id})" style="margin-left: 10px; padding: 2px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Сохранить</button>`);
        }
    }
    
    return `
        <html>
        <head>
            <title>АКТ выполненных работ #${data.device.id}</title>
            <style>
                body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
                .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
                .header { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 20px; text-align: center; }
                .header h1 { margin: 0; font-size: 24px; font-weight: 600; }
                .header .date { margin-top: 8px; opacity: 0.9; font-size: 14px; }
                .content { padding: 25px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
                .info-card { background: #f8f9fa; border-radius: 6px; padding: 15px; border-left: 4px solid #28a745; }
                .info-card h3 { margin: 0 0 12px 0; color: #333; font-size: 16px; font-weight: 600; }
                .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
                .info-row:last-child { margin-bottom: 0; }
                .info-label { font-weight: 600; color: #666; }
                .info-value { color: #333; }
                .work-section { background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 20px; margin-bottom: 25px; }
                .work-section h3 { margin: 0 0 15px 0; color: #155724; font-size: 16px; }
                .work-item { margin-bottom: 15px; }
                .work-item:last-child { margin-bottom: 0; }
                .work-item h4 { margin: 0 0 8px 0; color: #155724; font-size: 14px; font-weight: 600; }
                .work-text { color: #155724; font-size: 14px; line-height: 1.5; background: white; padding: 10px; border-radius: 4px; }
                .finance-card { background: #e7f3ff; border: 1px solid #b8daff; border-radius: 6px; padding: 20px; margin-bottom: 25px; }
                .finance-card h3 { margin: 0 0 15px 0; color: #004085; font-size: 16px; }
                .finance-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
                .finance-item { text-align: center; }
                .finance-label { font-size: 12px; color: #666; margin-bottom: 5px; }
                .finance-value { font-size: 18px; font-weight: 600; color: #004085; }
                .signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
                .signature-box { text-align: center; padding: 20px; border: 2px dashed #dee2e6; border-radius: 6px; }
                .signature-box h4 { margin: 0 0 15px 0; color: #666; font-size: 14px; font-weight: 600; }
                .signature-line { border-bottom: 1px solid #333; margin-bottom: 5px; height: 20px; }
                .signature-name { font-size: 12px; color: #666; }
                .footer { background: #f8f9fa; padding: 15px; text-align: center; font-size: 12px; color: #6c757d; border-top: 1px solid #dee2e6; }
                @media print { body { background: white; } .container { box-shadow: none; } }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>АКТ ВЫПОЛНЕННЫХ РАБОТ</h1>
                    <div class="date">${new Date().toLocaleDateString('ru-RU')}</div>
                </div>
                
                <div class="content">
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>🏢 Сервисный центр</h3>
                            <div class="info-row">
                                <span class="info-label">Название:</span>
                                <span class="info-value">${data.service ? data.service.name : 'Сервисный центр'}</span>
                            </div>
                            ${data.service && data.service.short_name ? `
                            <div class="info-row">
                                <span class="info-label">Сокращенное:</span>
                                <span class="info-value">${data.service.short_name}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.address ? `
                            <div class="info-row">
                                <span class="info-label">Адрес:</span>
                                <span class="info-value">${data.service.address}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.phone ? `
                            <div class="info-row">
                                <span class="info-label">Телефон:</span>
                                <span class="info-value">${data.service.phone}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.email ? `
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value">${data.service.email}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.inn ? `
                            <div class="info-row">
                                <span class="info-label">ИНН:</span>
                                <span class="info-value">${data.service.inn}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="info-card">
                            <h3>📱 Устройство</h3>
                            <div class="info-row">
                                <span class="info-label">ID:</span>
                                <span class="info-value">#${data.device.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Модель:</span>
                                <span class="info-value">${data.device.brand} ${data.device.model}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Серийный №:</span>
                                <span class="info-value">${data.device.serial_number || '—'}</span>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h3>👤 Клиент</h3>
                            <div class="info-row">
                                <span class="info-label">ФИО:</span>
                                <span class="info-value">${data.client.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Телефон:</span>
                                <span class="info-value">${data.client.phone || '—'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="work-section">
                        <h3>🔧 Выполненные работы</h3>
                        <div class="work-item">
                            <h4>Диагностика:</h4>
                            <div class="work-text">${diagnosis || data.diagnosis || 'Не указана'}</div>
                        </div>
                        <div class="work-item">
                            <h4>Примечание:</h4>
                            <div class="work-text">${workDescription || data.repair_description || 'Не указано'}</div>
                        </div>
                        ${approvedParts.length > 0 ? `
                        <div class="work-item">
                            <h4>Использованные запчасти:</h4>
                            <div class="work-text">
                                ${approvedParts.map(part => `• ${part}`).join('<br>')}
                            </div>
                        </div>
                        ` : ''}
                        ${approvedServices.length > 0 ? `
                        <div class="work-item">
                            <h4>Выполненные услуги:</h4>
                            <div class="work-text">
                                ${approvedServices.map(service => `• ${service}`).join('<br>')}
                            </div>
                        </div>
                        ` : ''}
                        ${approvedParts.length === 0 && approvedServices.length === 0 ? `
                        <div class="work-item">
                            <h4>Выполненные работы:</h4>
                            <div class="work-text">${data.work_performed || 'Не указаны'}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="finance-card">
                        <h3>💰 Финансовая информация</h3>
                        <div class="finance-grid">
                            <div class="finance-item">
                                <div class="finance-label">Общая стоимость</div>
                                <div class="finance-value" id="totalCost">${hasRejectionStatus ? diagnosisCost + ' ₽' : (data.cost_estimate ? data.cost_estimate + ' ₽' : '—')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="signatures">
                        <div class="signature-box">
                            <h4>Клиент</h4>
                            <div class="signature-line"></div>
                            <div class="signature-name">${data.client.name}</div>
                        </div>
                        <div class="signature-box">
                            <h4>Исполнитель</h4>
                            <div class="signature-line"></div>
                            <div class="signature-name">Мастер сервисного центра</div>
                        </div>
                    </div>
                </div>
                
                <div class="footer">
                    Документ сгенерирован системой управления сервисным центром
                </div>
            </div>
            
        </body>
        </html>
    `;
}

// Генерация АКТА О НЕРЕМОНТОПРИГОДНОСТИ
function generateUnrepairableAct(data) {
    return `
        <html>
        <head>
            <title>АКТ о неремонтопригодности #${data.device.id}</title>
            <style>
                body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
                .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
                .header { background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 20px; text-align: center; }
                .header h1 { margin: 0; font-size: 24px; font-weight: 600; }
                .header .date { margin-top: 8px; opacity: 0.9; font-size: 14px; }
                .content { padding: 25px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
                .info-card { background: #f8f9fa; border-radius: 6px; padding: 15px; border-left: 4px solid #dc3545; }
                .info-card h3 { margin: 0 0 12px 0; color: #333; font-size: 16px; font-weight: 600; }
                .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
                .info-row:last-child { margin-bottom: 0; }
                .info-label { font-weight: 600; color: #666; }
                .info-value { color: #333; }
                .reason-section { background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; padding: 20px; margin-bottom: 25px; }
                .reason-section h3 { margin: 0 0 15px 0; color: #721c24; font-size: 16px; }
                .reason-item { margin-bottom: 15px; }
                .reason-item:last-child { margin-bottom: 0; }
                .reason-item h4 { margin: 0 0 8px 0; color: #721c24; font-size: 14px; font-weight: 600; }
                .reason-text { color: #721c24; font-size: 14px; line-height: 1.5; background: white; padding: 10px; border-radius: 4px; }
                .cost-card { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 20px; margin-bottom: 25px; text-align: center; }
                .cost-card h3 { margin: 0 0 10px 0; color: #856404; font-size: 16px; }
                .cost-value { font-size: 24px; font-weight: 600; color: #856404; }
                .signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
                .signature-box { text-align: center; padding: 20px; border: 2px dashed #dee2e6; border-radius: 6px; }
                .signature-box h4 { margin: 0 0 15px 0; color: #666; font-size: 14px; font-weight: 600; }
                .signature-line { border-bottom: 1px solid #333; margin-bottom: 5px; height: 20px; }
                .signature-name { font-size: 12px; color: #666; }
                .footer { background: #f8f9fa; padding: 15px; text-align: center; font-size: 12px; color: #6c757d; border-top: 1px solid #dee2e6; }
                @media print { body { background: white; } .container { box-shadow: none; } }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>АКТ О НЕРЕМОНТОПРИГОДНОСТИ</h1>
                    <div class="date">${new Date().toLocaleDateString('ru-RU')}</div>
                </div>
                
                <div class="content">
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>🏢 Сервисный центр</h3>
                            <div class="info-row">
                                <span class="info-label">Название:</span>
                                <span class="info-value">${data.service ? data.service.name : 'Сервисный центр'}</span>
                            </div>
                            ${data.service && data.service.short_name ? `
                            <div class="info-row">
                                <span class="info-label">Сокращенное:</span>
                                <span class="info-value">${data.service.short_name}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.address ? `
                            <div class="info-row">
                                <span class="info-label">Адрес:</span>
                                <span class="info-value">${data.service.address}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.phone ? `
                            <div class="info-row">
                                <span class="info-label">Телефон:</span>
                                <span class="info-value">${data.service.phone}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.email ? `
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value">${data.service.email}</span>
                            </div>
                            ` : ''}
                            ${data.service && data.service.inn ? `
                            <div class="info-row">
                                <span class="info-label">ИНН:</span>
                                <span class="info-value">${data.service.inn}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="info-card">
                            <h3>📱 Устройство</h3>
                            <div class="info-row">
                                <span class="info-label">ID:</span>
                                <span class="info-value">#${data.device.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Модель:</span>
                                <span class="info-value">${data.device.brand} ${data.device.model}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Серийный №:</span>
                                <span class="info-value">${data.device.serial_number || '—'}</span>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h3>👤 Клиент</h3>
                            <div class="info-row">
                                <span class="info-label">ФИО:</span>
                                <span class="info-value">${data.client.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Телефон:</span>
                                <span class="info-value">${data.client.phone || '—'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="reason-section">
                        <h3>❌ Причина неремонтопригодности</h3>
                        <div class="reason-item">
                            <h4>Диагностика показала:</h4>
                            <div class="reason-text">${data.diagnosis || 'Не указана'}</div>
                        </div>
                        <div class="reason-item">
                            <h4>Причина невозможности ремонта:</h4>
                            <div class="reason-text">${data.repair_description || 'Не указана'}</div>
                        </div>
                        </div>
                        
                        <div class="cost-card">
                            <h3>💰 Стоимость диагностики</h3>
                            <div class="cost-value">${data.cost_estimate ? data.cost_estimate + ' ₽' : '—'}</div>
                        </div>
                        
                        <div class="signatures">
                            <div class="signature-box">
                                <h4>Клиент</h4>
                                <div class="signature-line"></div>
                                <div class="signature-name">${data.client.name}</div>
                            </div>
                            <div class="signature-box">
                                <h4>Мастер</h4>
                                <div class="signature-line"></div>
                                <div class="signature-name">Мастер сервисного центра</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="footer">
                    Документ сгенерирован системой управления сервисным центром
                </div>
            </div>
        </body>
        </html>
    `;
}
</script>

<style>
/* Стили для карточек заказов */
.order-card .card {
    transition: all 0.3s ease;
    border: 1px solid #e3e6f0;
}

.order-card .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.order-card .card-header {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
    border-bottom: none;
}

.order-card .card-footer {
    background: #f8f9fa;
    border-top: 1px solid #e3e6f0;
}

.order-card .btn-group .btn {
    border-color: rgba(255,255,255,0.3);
    color: white;
}

.order-card .btn-group .btn:hover {
    background-color: rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.5);
}

.order-card .badge {
    font-size: 0.75em;
    padding: 0.375rem 0.75rem;
}

/* Компактные стили для карточек заказов */
.order-card .card-header {
    padding: 0.5rem 0.75rem;
}

.order-card .card-header h6 {
    font-size: 0.9rem;
    margin: 0;
}

.order-card .card-body {
    padding: 0.75rem;
}

.order-card .card-footer {
    padding: 0.5rem 0.75rem;
}

.order-card .btn-group .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
}

.order-card .row {
    margin-bottom: 0.5rem;
}

.order-card .row:last-child {
    margin-bottom: 0;
}

.order-card strong {
    font-size: 0.8rem;
    font-weight: 600;
}

.order-card .text-success {
    font-size: 0.9rem;
    font-weight: 600;
}

.order-card .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

.order-card .btn-sm {
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
}

.order-card small {
    font-size: 0.7rem;
}

.order-card .text-primary {
    font-size: 0.85rem;
}
</style>

<!-- Print Document Type Selection Modal -->
<div class="modal fade" id="printDocumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-printer"></i> Выберите тип документа для печати
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-primary" style="cursor: pointer;" onclick="printDocument('acceptance')">
                            <div class="card-body text-center">
                                <i class="bi bi-file-earmark-text text-primary" style="font-size: 3rem;"></i>
                                <h6 class="card-title mt-3">АКТ приема</h6>
                                <p class="card-text small text-muted">Документ о приеме устройства в ремонт</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-success" style="cursor: pointer;" onclick="printDocument('completed_work')">
                            <div class="card-body text-center">
                                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                                <h6 class="card-title mt-3">АКТ выполненных работ</h6>
                                <p class="card-text small text-muted">Документ о выполненных ремонтных работах</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-danger" style="cursor: pointer;" onclick="printDocument('unrepairable')">
                            <div class="card-body text-center">
                                <i class="bi bi-x-circle text-danger" style="font-size: 3rem;"></i>
                                <h6 class="card-title mt-3">АКТ о неремонтопригодности</h6>
                                <p class="card-text small text-muted">Документ о невозможности ремонта</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения "Взять в работу" -->
<div class="modal fade" id="confirmTakeToWorkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-question-circle"></i> Подтвердите действие
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center mb-0">
                    Вы уверены, что хотите взять этот заказ в работу?<br>
                    <strong>Устройство будет перемещено на страницу "Устройства".</strong>
                </p>
                <input type="hidden" id="confirmOrderId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="confirmTakeToWork()">
                    <i class="bi bi-check-circle"></i> Подтвердить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно предварительного просмотра документа -->
<div class="modal fade" id="documentPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-a4">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-eye"></i> Предварительный просмотр: <span id="previewDocumentType"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body a4-preview">
                <div id="documentPreviewContent" class="a4-document">
                    <!-- Содержимое документа будет загружено здесь -->
                </div>
                <input type="hidden" id="previewDocumentTypeValue">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="printFromPreview()">
                    <i class="bi bi-printer"></i> Печать
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Обработчик события для модального окна предварительного просмотра
document.addEventListener('DOMContentLoaded', function() {
    const documentPreviewModal = document.getElementById('documentPreviewModal');
    if (documentPreviewModal) {
        documentPreviewModal.addEventListener('hidden.bs.modal', function() {
            // Очищаем содержимое при закрытии модального окна
            const content = document.getElementById('documentPreviewContent');
            if (content) {
                content.innerHTML = '';
            }
        });
    }
    
    // Обновляем стоимость всех заказов с учетом АВР
    updateAllOrdersCost();
});

// Изменение статуса заказа
function changeOrderStatus(orderId, currentStatus) {
    document.getElementById('changeStatusOrderId').value = orderId;
    document.getElementById('changeStatusOldStatus').value = currentStatus;
    document.getElementById('newStatus').value = currentStatus;
    document.getElementById('statusComment').value = '';
    
    new bootstrap.Modal(document.getElementById('changeStatusModal')).show();
}

// Получение суммы диагностики из АВР для заказов с отказом от ремонта
function getDiagnosisCostFromAVR(orderId) {
    return new Promise((resolve) => {
        // Получаем данные заказа
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.order) {
                    // Проверяем, есть ли в истории статус "Отказ от ремонта"
                    const hasRejectionStatus = data.order.status_history && 
                        data.order.status_history.some(entry => entry.new_status === 'rejected');
                    
                    if (hasRejectionStatus) {
                        // Если есть отказ от ремонта, показываем модальное окно для ввода суммы диагностики
                        showDiagnosisCostModal(orderId, resolve);
                    } else {
                        resolve(500); // Базовая сумма для обычных заказов
                    }
                } else {
                    resolve(500);
                }
            })
            .catch(() => resolve(500));
    });
}

// Показ модального окна для ввода суммы диагностики
function showDiagnosisCostModal(orderId, callback) {
    const modalHtml = `
        <div class="modal fade" id="diagnosisCostModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">💰 Сумма диагностики</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Для заказа с отказом от ремонта укажите сумму диагностики:</p>
                        <div class="mb-3">
                            <label for="diagnosisCostInput" class="form-label">Сумма диагностики (₽):</label>
                            <input type="number" class="form-control" id="diagnosisCostInput" value="500" min="0" step="10">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" onclick="confirmDiagnosisCost(${orderId})">Подтвердить</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Удаляем предыдущее модальное окно, если есть
    const existingModal = document.getElementById('diagnosisCostModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Добавляем новое модальное окно
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Сохраняем callback в глобальной переменной
    window.diagnosisCostCallback = callback;
    
    // Показываем модальное окно
    new bootstrap.Modal(document.getElementById('diagnosisCostModal')).show();
}

// Подтверждение суммы диагностики
function confirmDiagnosisCost(orderId) {
    const cost = document.getElementById('diagnosisCostInput').value;
    const costValue = parseFloat(cost) || 500;
    
    // Закрываем модальное окно
    bootstrap.Modal.getInstance(document.getElementById('diagnosisCostModal')).hide();
    
    // Вызываем callback с суммой
    if (window.diagnosisCostCallback) {
        window.diagnosisCostCallback(costValue);
        window.diagnosisCostCallback = null;
    }
}

// Получение суммы диагностики для заказов с отказом от ремонта
function getDiagnosisCostForRejection(orderId) {
    return new Promise((resolve) => {
        // Получаем данные заказа
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.order) {
                    // Проверяем, есть ли в истории статус "Отказ от ремонта"
                    const hasRejectionStatus = data.order.status_history && 
                        data.order.status_history.some(entry => entry.new_status === 'rejected');
                    
                    if (hasRejectionStatus) {
                        // Если есть отказ от ремонта, показываем модальное окно для ввода суммы диагностики
                        showDiagnosisCostModal(orderId, resolve);
                    } else {
                        resolve(500); // Базовая сумма для обычных заказов
                    }
                } else {
                    resolve(500);
                }
            })
            .catch(() => resolve(500));
    });
}

// Показ модального окна для ввода суммы диагностики
function showDiagnosisCostModal(orderId, callback) {
    const modalHtml = `
        <div class="modal fade" id="diagnosisCostModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">💰 Сумма диагностики</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Для заказа с отказом от ремонта укажите сумму диагностики:</p>
                        <div class="mb-3">
                            <label for="diagnosisCostInput" class="form-label">Сумма диагностики (₽):</label>
                            <input type="number" class="form-control" id="diagnosisCostInput" value="500" min="0" step="10">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" onclick="confirmDiagnosisCost(${orderId})">Подтвердить</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Удаляем предыдущее модальное окно, если есть
    const existingModal = document.getElementById('diagnosisCostModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Добавляем новое модальное окно
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Сохраняем callback в глобальной переменной
    window.diagnosisCostCallback = callback;
    
    // Показываем модальное окно
    new bootstrap.Modal(document.getElementById('diagnosisCostModal')).show();
}

// Подтверждение суммы диагностики
function confirmDiagnosisCost(orderId) {
    const cost = document.getElementById('diagnosisCostInput').value;
    const costValue = parseFloat(cost) || 500;
    
    // Закрываем модальное окно
    bootstrap.Modal.getInstance(document.getElementById('diagnosisCostModal')).hide();
    
    // Вызываем callback с суммой
    if (window.diagnosisCostCallback) {
        window.diagnosisCostCallback(costValue);
        window.diagnosisCostCallback = null;
    }
}

// Сохранение суммы диагностики в АВР
function saveDiagnosisCost(orderId) {
    const cost = document.getElementById('diagnosisCost').value;
    const costValue = parseFloat(cost) || 500;
    
    // Отправляем запрос на сохранение суммы диагностики
    fetch(`/api/orders/${orderId}/save-diagnosis-cost`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            diagnosis_cost: costValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Показываем уведомление об успешном сохранении
            const button = document.getElementById('saveDiagnosisCost');
            const originalText = button.textContent;
            button.textContent = 'Сохранено!';
            button.style.background = '#28a745';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#007bff';
            }, 2000);
        } else {
            alert('Ошибка при сохранении суммы диагностики: ' + (data.message || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка при сохранении суммы диагностики');
    });
}

// Сохранение изменения статуса
async function saveStatusChange() {
    const orderId = document.getElementById('changeStatusOrderId').value;
    const newStatus = document.getElementById('newStatus').value;
    const comment = document.getElementById('statusComment').value;
    
    if (!newStatus) {
        alert('Выберите новый статус');
        return;
    }
    
    // Если статус "Выдано", проверяем сумму диагностики для заказов с отказом от ремонта
    if (newStatus === 'completed') {
        const diagnosisCost = await getDiagnosisCostForRejection(orderId);
        await sendStatusChangeRequest(orderId, newStatus, comment, diagnosisCost);
    } else {
        await sendStatusChangeRequest(orderId, newStatus, comment, 500);
    }
}

// Отправка запроса на изменение статуса
async function sendStatusChangeRequest(orderId, newStatus, comment, diagnosisCost) {
    // Получаем сумму АВР для этого заказа
    let abrTotal = 0;
    if (newStatus === 'completed') {
        abrTotal = await calculateOrderWorkReportsTotal(orderId);
    }
    
    fetch(`/api/orders/${orderId}/change-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            new_status: newStatus,
            comment: comment,
            diagnosis_cost: diagnosisCost,
            abr_total: abrTotal
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            bootstrap.Modal.getInstance(document.getElementById('changeStatusModal')).hide();
            
            // Обновляем страницу
            location.reload();
        } else {
            alert('Ошибка: ' + (data.message || 'Не удалось изменить статус'));
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка при изменении статуса');
    });
}

// Обновление общей стоимости при изменении суммы диагностики в АВР
document.addEventListener('DOMContentLoaded', function() {
    // Ждем загрузки модального окна с предварительным просмотром
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                const diagnosisCostInput = document.getElementById('diagnosisCost');
                const totalCostElement = document.getElementById('totalCost');
                
                if (diagnosisCostInput && totalCostElement) {
                    diagnosisCostInput.addEventListener('input', function() {
                        const cost = this.value || 0;
                        totalCostElement.textContent = cost + ' ₽';
                    });
                }
            }
        });
    });
    
    // Наблюдаем за изменениями в DOM
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});

// ===== ФУНКЦИИ ДЛЯ РАБОТЫ С АВР В ЗАКАЗАХ =====

// Просмотр АВР из заказа
async function viewWorkReportFromOrder(reportId) {
    try {
        console.log('Поиск АВР с ID:', reportId);
        const workReports = JSON.parse(localStorage.getItem('workReports') || '{}');
        console.log('Все АВР в localStorage:', workReports);
        
        let foundReport = null;
        let deviceId = null;
        
        // Ищем АВР по ID во всех устройствах
        for (const [devId, reports] of Object.entries(workReports)) {
            console.log(`Проверяем устройство ${devId}:`, reports);
            const report = reports.find(r => r.id == reportId); // Используем == вместо === для сравнения строки и числа
            if (report) {
                foundReport = report;
                deviceId = devId;
                console.log('Найден АВР:', report);
                break;
            }
        }
        
        if (!foundReport) {
            console.log('АВР не найден. Доступные ID:', Object.values(workReports).flat().map(r => r.id));
            showNotification('Ошибка', 'АВР не найден', 'error');
            return;
        }
        
        // Получаем актуальные данные устройства
        let deviceData = {};
        let clientData = {};
        
        try {
            const response = await fetch(`/api/devices/${deviceId}`);
            const deviceResponse = await response.json();
            if (deviceResponse && deviceResponse.id) {
                deviceData = deviceResponse;
                clientData = deviceData.client || {};
            }
        } catch (error) {
            console.error('Ошибка загрузки данных устройства:', error);
        }
        
        // Создаем модальное окно для просмотра
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'viewWorkReportFromOrderModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Просмотр АВР #${foundReport.id}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Дата создания:</strong> ${new Date(foundReport.created_at).toLocaleString('ru-RU')}
                            </div>
                            <div class="col-md-6">
                                <strong>Общая стоимость:</strong> ${foundReport.total_cost} ₽
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Клиент:</strong> ${clientData.name || 'Не указан'}<br>
                                <strong>Телефон:</strong> ${clientData.phone || 'Не указан'}<br>
                                <strong>Адрес:</strong> ${clientData.address || 'Не указан'}<br>
                                <strong>Email:</strong> ${clientData.email || 'Не указан'}
                            </div>
                            <div class="col-md-6">
                                <strong>Устройство:</strong> ${deviceData.brand || ''} ${deviceData.model || ''}<br>
                                <strong>Серийный номер:</strong> ${deviceData.serial_number || 'Не указан'}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Примечание:</strong>
                            <p class="mt-1">${foundReport.work_description || 'Не указано'}</p>
                        </div>
                        
                        ${foundReport.parts.length > 0 ? `
                        <div class="mb-3">
                            <strong>Использованные запчасти:</strong>
                            <ul class="mt-1">
                                ${foundReport.parts.map(part => `
                                    <li>${part.name} - ${part.quantity} шт. × ${part.price} ₽ = ${part.total} ₽</li>
                                `).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${foundReport.services.length > 0 ? `
                        <div class="mb-3">
                            <strong>Выполненные услуги:</strong>
                            <ul class="mt-1">
                                ${foundReport.services.map(service => `
                                    <li>${service.name} - ${service.price} ₽</li>
                                `).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${foundReport.notes ? `
                        <div class="mb-3">
                            <strong>Примечания:</strong>
                            <p class="mt-1">${foundReport.notes}</p>
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="button" class="btn btn-success" onclick="printWorkReportFromOrder(${foundReport.id})">
                            <i class="bi bi-printer"></i> Печать
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Удаляем модальное окно после закрытия
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
        
    } catch (error) {
        console.error('Ошибка при просмотре АВР:', error);
        showNotification('Ошибка', 'Не удалось открыть АВР', 'error');
    }
}

// Печать АВР из заказа
async function printWorkReportFromOrder(reportId) {
    try {
        console.log('Печать АВР с ID:', reportId);
        const workReports = JSON.parse(localStorage.getItem('workReports') || '{}');
        console.log('Все АВР в localStorage:', workReports);
        
        let foundReport = null;
        let orderId = null;
        
        // Ищем АВР по ID во всех устройствах
        let deviceId = null;
        for (const [devId, reports] of Object.entries(workReports)) {
            console.log(`Проверяем устройство ${devId}:`, reports);
            const report = reports.find(r => r.id == reportId); // Используем == вместо === для сравнения строки и числа
            if (report) {
                foundReport = report;
                deviceId = devId;
                console.log('Найден АВР для печати:', report);
                break;
            }
        }
        
        if (!foundReport) {
            console.log('АВР не найден для печати. Доступные ID:', Object.values(workReports).flat().map(r => r.id));
            showNotification('Ошибка', 'АВР не найден', 'error');
            return;
        }
        
        // Получаем актуальные данные устройства
        let deviceData = {};
        let clientData = {};
        
        try {
            const response = await fetch(`/api/devices/${deviceId}`);
            const deviceResponse = await response.json();
            if (deviceResponse && deviceResponse.id) {
                deviceData = deviceResponse;
                clientData = deviceData.client || {};
            }
        } catch (error) {
            console.error('Ошибка загрузки данных устройства:', error);
        }
        
        // Формируем данные для печати
        const printData = {
            deviceId: deviceId,
            clientName: clientData.name || 'Не указан',
            clientPhone: clientData.phone || 'Не указан',
            clientAddress: clientData.address || 'Не указан',
            clientEmail: clientData.email || 'Не указан',
            deviceInfo: `${deviceData.brand || ''} ${deviceData.model || ''}`.trim(),
            serialNumber: deviceData.serial_number || 'Не указан',
            workStartDate: foundReport.work_start_date,
            workEndDate: foundReport.work_end_date,
            workDescription: foundReport.work_description,
            totalCost: foundReport.total_cost,
            warrantyPeriod: foundReport.warranty_period,
            notes: foundReport.notes,
            parts: foundReport.parts,
            services: foundReport.services
        };
        
        // Генерируем HTML для печати (используем функцию из devices.html)
        const printHTML = await generateWorkReportPrintHTML(printData, deviceData, {});
        
        // Создаем новое окно для печати
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
        // Ждем загрузки и печатаем
        printWindow.onload = function() {
            printWindow.print();
        };
        
    } catch (error) {
        console.error('Ошибка при печати АВР:', error);
        showNotification('Ошибка', 'Не удалось распечатать АВР', 'error');
    }
}

// Удаление АВР из заказа
function deleteWorkReportFromOrder(reportId, orderId) {
    if (!confirm('Вы уверены, что хотите удалить этот АВР?')) {
        return;
    }
    
    try {
        const workReports = JSON.parse(localStorage.getItem('workReports') || '{}');
        // Ищем АВР во всех устройствах
        for (const [deviceId, reports] of Object.entries(workReports)) {
            const reportIndex = reports.findIndex(r => r.id === reportId);
            if (reportIndex !== -1) {
                reports.splice(reportIndex, 1);
                localStorage.setItem('workReports', JSON.stringify(workReports));
                loadOrderStatusHistory(orderId); // Обновляем историю
                
                // Обновляем стоимость заказа
                updateOrderCost(orderId);
                
                showNotification('Успех', 'АВР удален', 'success');
                return;
            }
        }
        showNotification('Ошибка', 'АВР не найден', 'error');
    } catch (error) {
        console.error('Ошибка при удалении АВР:', error);
        showNotification('Ошибка', 'Не удалось удалить АВР', 'error');
    }
}

// Функция генерации HTML для печати АВР (копия из devices.html)
async function generateWorkReportPrintHTML(reportData, deviceData, serviceData) {
    const currentDate = new Date().toLocaleDateString('ru-RU');
    const currentTime = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    // Извлекаем данные из переданных параметров
    const data = {
        deviceId: reportData.id,
        clientName: deviceData.client ? deviceData.client.name : 'Не указан',
        clientPhone: deviceData.client ? deviceData.client.phone : 'Не указан',
        clientAddress: deviceData.client ? deviceData.client.address : 'Не указан',
        clientEmail: deviceData.client ? deviceData.client.email : 'Не указан',
        deviceInfo: `${deviceData.brand} ${deviceData.model}`,
        serialNumber: deviceData.serial_number || 'Не указан',
        workDescription: reportData.work_description || 'Не указано',
        parts: reportData.parts || [],
        services: reportData.services || [],
        totalCost: reportData.total_cost || 0,
        warrantyPeriod: reportData.warranty_period || '30'
    };
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Акт выполненных работ №${data.deviceId}</title>
            <meta charset="utf-8">
            <style>
                @page {
                    size: A4;
                    margin: 1cm;
                }
                
                body {
                    font-family: 'Times New Roman', serif;
                    font-size: 9pt;
                    line-height: 1.1;
                    margin: 0;
                    padding: 5px;
                    color: #000;
                    background: white;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 15px;
                    border-bottom: 1px solid #000;
                    padding-bottom: 8px;
                }
                
                .header h1 {
                    font-size: 14pt;
                    font-weight: bold;
                    margin: 0 0 5px 0;
                    text-transform: uppercase;
                }
                
                .header h2 {
                    font-size: 11pt;
                    font-weight: bold;
                    margin: 0;
                }
                
                .document-info {
                    text-align: right;
                    margin-bottom: 10px;
                    font-size: 9pt;
                }
                
                .parties {
                    margin-bottom: 15px;
                }
                
                .parties .row {
                    display: flex;
                    flex-wrap: nowrap;
                }
                
                .parties .col-6 {
                    flex: 0 0 50%;
                    max-width: 50%;
                    padding-right: 15px;
                }
                
                .parties .col-6:last-child {
                    padding-right: 0;
                    padding-left: 15px;
                }
                
                .party {
                    margin-bottom: 8px;
                }
                
                .party-title {
                    font-weight: bold;
                    font-size: 10pt;
                    margin-bottom: 4px;
                }
                
                .party-info {
                    margin-left: 15px;
                    font-size: 9pt;
                }
                
                .device-info {
                    background: #f8f9fa;
                    padding: 8px;
                    border: 1px solid #dee2e6;
                    margin-bottom: 10px;
                }
                
                .device-info h3 {
                    font-size: 10pt;
                    font-weight: bold;
                    margin: 0 0 5px 0;
                }
                
                .work-description {
                    margin: 10px 0;
                }
                
                .work-description h3 {
                    font-size: 10pt;
                    font-weight: bold;
                    margin: 0 0 5px 0;
                }
                
                .parts-services h3 {
                    font-size: 10pt;
                    font-weight: bold;
                    margin: 0 0 5px 0;
                }
                
                .parts-table, .services-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 10px 0;
                }
                
                .parts-table th, .parts-table td,
                .services-table th, .services-table td {
                    border: 1px solid #000;
                    padding: 3px 5px;
                    text-align: left;
                    font-size: 9pt;
                    line-height: 1.1;
                    white-space: nowrap;
                }
                
                .parts-table td:first-child {
                    white-space: normal;
                    max-width: 180px;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }
                
                .total-section {
                    margin: 10px 0;
                    text-align: right;
                }
                
                .total-section h3 {
                    font-size: 10pt;
                    font-weight: bold;
                    margin: 0 0 5px 0;
                }
                
                .signatures {
                    margin-top: 20px;
                }
                
                .signatures .row {
                    display: flex;
                    flex-wrap: nowrap;
                }
                
                .signatures .col-6 {
                    flex: 0 0 50%;
                    max-width: 50%;
                    padding-right: 15px;
                }
                
                .signatures .col-6:last-child {
                    padding-right: 0;
                    padding-left: 15px;
                }
                
                .signature-block {
                    display: inline-block;
                    width: 45%;
                    margin: 5px 2.5%;
                    vertical-align: top;
                }
                
                .signature-line {
                    border-bottom: 1px solid #000;
                    height: 20px;
                    margin: 5px 0;
                }
                
                .footer {
                    margin-top: 15px;
                    font-size: 8pt;
                    color: #666;
                    text-align: center;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Акт выполненных работ</h1>
                <h2>№ ${data.deviceId} от ${currentDate}</h2>
            </div>
            
            <div class="document-info">
                <strong>Дата составления:</strong> ${currentDate}<br>
                <strong>Время:</strong> ${currentTime}
            </div>
            
            <div class="parties">
                <div class="row">
                    <div class="col-6">
                        <div class="party">
                            <div class="party-title">Исполнитель:</div>
                            <div class="party-info">
                                <strong>${serviceData ? serviceData.name : 'Сервисный центр'}</strong><br>
                                ${serviceData && serviceData.legal_address ? `Юридический адрес: ${serviceData.legal_address}<br>` : ''}
                                ${serviceData && serviceData.address ? `Фактический адрес: ${serviceData.address}<br>` : ''}
                                ${serviceData && serviceData.phone ? `Телефон: ${serviceData.phone}<br>` : ''}
                                ${serviceData && serviceData.email ? `Email: ${serviceData.email}<br>` : ''}
                                ${serviceData && serviceData.inn ? `ИНН: ${serviceData.inn}<br>` : ''}
                                ${serviceData && serviceData.ogrn ? `ОГРН: ${serviceData.ogrn}` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="party">
                            <div class="party-title">Заказчик:</div>
                            <div class="party-info">
                                <strong>${data.clientName}</strong><br>
                                ${data.clientPhone && data.clientPhone !== 'Не указан' ? `Телефон: ${data.clientPhone}<br>` : ''}
                                ${data.clientAddress && data.clientAddress !== 'Не указан' ? `Адрес: ${data.clientAddress}<br>` : ''}
                                ${data.clientEmail && data.clientEmail !== 'Не указан' ? `Email: ${data.clientEmail}` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="device-info">
                <h3>Информация об устройстве</h3>
                <div class="row">
                    <div class="col-6"><strong>Устройство:</strong> ${data.deviceInfo}</div>
                    <div class="col-6"><strong>Серийный номер:</strong> ${data.serialNumber}</div>
                </div>
            </div>
            
            <div class="work-description">
                <h3>Выполненные работы</h3>
                <p><strong>Примечание:</strong> ${data.workDescription || 'Не указано'}</p>
            </div>
            
            ${data.parts && data.parts.length > 0 ? `
            <div class="parts-services">
                <h3>Использованные запчасти</h3>
                <table class="parts-table">
                    <thead>
                        <tr>
                            <th>Наименование</th>
                            <th>Количество</th>
                            <th>Цена за ед.</th>
                            <th>Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.parts.map(part => `
                            <tr>
                                <td>${part.name}</td>
                                <td>${part.quantity}</td>
                                <td>${part.price.toFixed(2)} ₽</td>
                                <td>${part.total.toFixed(2)} ₽</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ` : ''}
            
            ${data.services && data.services.length > 0 ? `
            <div class="parts-services">
                <h3>Выполненные услуги</h3>
                <table class="services-table">
                    <thead>
                        <tr>
                            <th>Наименование услуги</th>
                            <th>Стоимость</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.services.map(service => `
                            <tr>
                                <td>${service.name}</td>
                                <td>${service.price.toFixed(2)} ₽</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ` : ''}
            
            <div class="total-section">
                <h3>Итоговая стоимость работ: ${data.totalCost} ₽</h3>
                <p><strong>Гарантийный срок:</strong> ${data.warrantyPeriod || '30'} дней</p>
            </div>
            
            <div class="signatures">
                <div class="row">
                    <div class="col-6">
                        <div class="signature-block">
                            <strong>Исполнитель:</strong><br>
                            <div class="signature-line"></div>
                            <div style="text-align: center; margin-top: 5px;">
                                (подпись) / (ФИО)
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="signature-block">
                            <strong>Заказчик:</strong><br>
                            <div class="signature-line"></div>
                            <div style="text-align: center; margin-top: 5px;">
                                (подпись) / (ФИО)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>Документ сгенерирован автоматически ${currentDate} в ${currentTime}</p>
            </div>
        </body>
        </html>
    `;
}

// Функция подсчета суммы АВР для заказа
function calculateOrderWorkReportsTotal(orderId) {
    try {
        // Получаем все АВР из localStorage
        const workReports = JSON.parse(localStorage.getItem('workReports') || '{}');
        
        // Находим устройство для этого заказа
        // Сначала получаем данные заказа
        return fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(orderData => {
                if (!orderData || !orderData.device_id) {
                    return 0;
                }
                
                const deviceId = orderData.device_id.toString();
                const deviceReports = workReports[deviceId] || [];
                
                // Суммируем все АВР для этого устройства
                let total = 0;
                deviceReports.forEach(report => {
                    if (report.total_cost) {
                        total += parseFloat(report.total_cost) || 0;
                    }
                });
                
                return total;
            })
            .catch(error => {
                console.error('Ошибка при подсчете суммы АВР:', error);
                return 0;
            });
    } catch (error) {
        console.error('Ошибка при подсчете суммы АВР:', error);
        return Promise.resolve(0);
    }
}

// Функция обновления стоимости в карточке заказа
function updateOrderCost(orderId) {
    calculateOrderWorkReportsTotal(orderId).then(total => {
        const costElement = document.getElementById(`order-cost-${orderId}`);
        if (costElement && total > 0) {
            costElement.textContent = `${total.toFixed(2)} ₽`;
            costElement.style.color = '#28a745'; // Зеленый цвет для АВР
        }
    });
}

// Функция обновления стоимости для всех заказов на странице
function updateAllOrdersCost() {
    // Находим все карточки заказов и обновляем их стоимость
    const orderCards = document.querySelectorAll('[id^="order-cost-"]');
    orderCards.forEach(card => {
        const orderId = card.id.replace('order-cost-', '');
        updateOrderCost(orderId);
    });
}

// Функция показа уведомлений
function showNotification(title, message, type) {
    // Создаем уведомление
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong>${title}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Экспортируем функции в глобальную область видимости
window.viewOrder = viewOrder;
window.editOrder = editOrder;
window.changeStatus = changeStatus;
window.changeOrderStatus = changeOrderStatus;
window.showAcceptanceAct = showAcceptanceAct;
window.takeToWork = takeToWork;
window.getStatusColor = getStatusColor;
window.showAlert = showAlert;
</script>

{% endblock %}

